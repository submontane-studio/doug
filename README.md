# Doug

コミック画像をリアルタイムで翻訳し、吹き出し上にオーバーレイ表示するChrome拡張機能（v1.5.2）。

AIビジョンAPIを使って英語テキストを検出・翻訳します。ユーザーが明示的に許可したサイトのみで動作します。

## 主な機能

### 翻訳

- コミック画像内の吹き出し・キャプション・効果音を自動検出
- テキスト位置を座標付きで取得し、元の吹き出し上にオーバーレイ表示
- 吹き出しの背景色（単色・グラデーション）とボーダーを再現
- 翻訳ボタン1クリックで現在ページを翻訳
- 自動翻訳ON/OFFトグル（ページ遷移時に自動で翻訳実行）

### 先読み翻訳

- 翻訳完了後、次2ページをバックグラウンドで自動翻訳
- 現在ページの翻訳・表示が完了した後にのみ動作（表示中は先読みを行わない）
- 翻訳APIは1件ずつ直列処理（レート制限対応）、次バッチの画像fetchは並行実施
- 画面下部のプログレスバーで進捗を表示
- 設定画面でON/OFF切替可能

### ホワイトリスト（任意サイト対応）

- 設定ポップアップの「このサイトで翻訳を有効化」ボタンで任意のコミックサイトを登録
- 登録時にAIがページのスクリーンショットを解析し、コミックページかどうかを自動判定
  - コミックと判定された場合 → 自動登録
  - コミック以外と判定された場合 → 「解析を無視して登録」か「キャンセル」を選択
- 右クリックメニューからも登録・解除が可能
- 登録情報は `chrome.storage.sync` に保存（デバイス間で同期）
- 次回以降は訪問時に自動でコンテンツスクリプトをインジェクト

### キャッシュ

- 翻訳結果を `chrome.storage.local` に保存（TTL: 30日）
- URL正規化によりトークン変動を吸収し、同一画像のキャッシュを確実にHIT
- 設定画面からキャッシュの手動クリアも可能

## 対応APIプロバイダー

| プロバイダー | 翻訳モデル（選択可） | 解析モデル（自動） |
|---|---|---|
| **Gemini** | gemini-2.5-pro / gemini-2.5-flash / gemini-2.5-flash-lite 他 | gemini-2.0-flash-lite |
| **Claude** | claude-opus-4-6 / claude-sonnet-4-6 / claude-haiku-4-5-20251001 | claude-haiku-4-5-20251001 |
| **ChatGPT** | gpt-5.2-2025-12-11 / gpt-5.2-pro-2025-12-11 | gpt-4o-mini |
| **Ollama** | qwen3-vl:8b 他（ローカル実行） | 設定中のモデルをそのまま使用 |

> 解析モデルはホワイトリスト登録時のコミック判定に使用。現在選択中のプロバイダーで最軽量のモデルが自動選択されます。

## 対応言語

日本語 / 韓国語 / 簡体字中国語 / 繁体字中国語 / スペイン語 / フランス語 / ドイツ語 / ポルトガル語

## セットアップ

1. `chrome://extensions` を開き、「デベロッパーモード」を有効化
2. 「パッケージ化されていない拡張機能を読み込む」で `doug` フォルダを選択
3. ツールバーのDougアイコンをクリックし、設定画面を開く
4. 使用するAPIプロバイダーを選択し、APIキーを入力して「保存」

### APIキーの取得

- **Gemini**: [Google AI Studio](https://aistudio.google.com/apikey) で取得（無料枠あり）
- **Claude**: [Anthropic Console](https://console.anthropic.com/) で取得
- **ChatGPT**: [OpenAI Platform](https://platform.openai.com/api-keys) で取得
- **Ollama**: ローカル実行のためAPIキー不要（[Ollama](https://ollama.com/) を別途インストール）

## 使い方

### サイトの登録

1. 翻訳したいコミックサイトを開く
2. ツールバーのDougアイコンをクリック
3. 「このサイトで翻訳を有効化」をクリック → 権限を許可
4. AIがページを解析し、コミックと判定されれば自動登録
5. 次回以降は訪問時に自動でツールバーが表示される

### 翻訳

1. 登録済みサイトでコミックを開く
2. 画面上にDougのツールバーが表示される
3. 「翻訳」ボタンをクリックすると、現在ページの翻訳が実行される
4. 先読みが有効の場合、次2ページがバックグラウンドで自動翻訳される
5. 翻訳済みのページに移動すると、キャッシュから即座にオーバーレイを表示

### ツールバー操作

| ボタン | 機能 |
|---|---|
| 翻訳 | 現在ページを翻訳してオーバーレイ表示 |
| 自動 | 自動翻訳のON/OFF切替 |
| 表示/非表示 | オーバーレイの表示切替 |
| クリア | オーバーレイを削除 |

ツールバーはドラッグで自由に移動できます。

## 構成ファイル

```
doug/
├── manifest.json        # 拡張機能の定義
├── background.js        # Service Worker（API・キャッシュ・先読み・ホワイトリスト管理）
├── content.js           # コンテンツスクリプト（UI・オーバーレイ描画・先読みトリガー）
├── content.css          # オーバーレイのスタイル
├── popup.html/js/css    # 設定ポップアップ
└── icons/               # 拡張機能アイコン（16/32/48/128px）
```

## 技術仕様

### レート制限対策

APIの429応答時は最大3回リトライ。`Retry-After` ヘッダーがあればその値を使用し、なければ10秒・20秒・30秒の段階的バックオフで再試行します。

### ホワイトリストの動的インジェクト

`chrome.permissions.request` でオリジン単位の権限を動的に取得し、`chrome.scripting.executeScript` でコンテンツスクリプトを即時インジェクト。`chrome.tabs.onUpdated` により次回訪問時も自動インジェクトします。Service Workerの再起動後も `chrome.storage.sync` からホワイトリストを復元して正常動作します。

### ページ検出

`MutationObserver` を3系統使ってページ遷移を検知します（DOM追加監視・SVG `<image>` の属性変化・通常 `<img>` の src 変化）。Blob URL画像はviewport外の位置情報をもとに次ページを特定します。

### オーバーレイ描画

- AIが返す正規化座標（0-1000）をパーセンテージに変換
- 吹き出しのbboxを上下10%拡張して表示
- 重なりがある場合は自動的に縮小調整
- フォントサイズは面積と文字数から推定し、収まらない場合は最小6pxまで縮小
