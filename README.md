# Doug

コミック画像をリアルタイムで翻訳し、吹き出し上にオーバーレイ表示するChrome拡張機能。

Marvel Unlimited のリーダー上で動作し、AIビジョンAPIを使って英語テキストを検出・翻訳します。

## 主な機能

### 翻訳

- コミック画像内の吹き出し・キャプション・効果音を自動検出
- テキスト位置を座標付きで取得し、元の吹き出し上にオーバーレイ表示
- 吹き出しの背景色（単色・グラデーション）とボーダーを再現
- 翻訳ボタン1クリックで現在ページを翻訳

### 先読み翻訳

- 現在ページを起点に、次5ページ・前2ページ（最大8ページ）を自動で先読み翻訳
- 2件並列処理 + 画像の先行fetchで高速化
- 先読み時は軽量モデル（`gemini-2.0-flash-lite`）を使用してレスポンス速度を優先
- 画面下部のプログレスバーで進捗を表示
- 設定画面でON/OFF切替可能

### キャッシュ

- 翻訳結果を `chrome.storage.local` に保存（TTL: 30日）
- URL正規化によりトークン変動を吸収し、同一画像のキャッシュを確実にHIT
- 容量が8MBを超えた場合、古いキャッシュから自動削除
- 設定画面からキャッシュの手動クリアも可能

## 対応APIプロバイダー

| プロバイダー | モデル | 用途 |
|---|---|---|
| **Gemini** | `gemini-3-flash-preview` | 通常翻訳（デフォルト） |
| **Gemini** | `gemini-2.0-flash-lite` | 先読み翻訳（自動切替） |
| **Claude** | `claude-sonnet-4-5-20250929` | 通常翻訳・先読み翻訳 |
| **ChatGPT** | `gpt-4o` | 通常翻訳・先読み翻訳 |

## 対応言語

日本語 / 韓国語 / 簡体字中国語 / 繁体字中国語 / スペイン語 / フランス語 / ドイツ語 / ポルトガル語

## セットアップ

1. `chrome://extensions` を開き、「デベロッパーモード」を有効化
2. 「パッケージ化されていない拡張機能を読み込む」で `doug` フォルダを選択
3. ツールバーのDougアイコンをクリックし、設定画面を開く
4. 使用するAPIプロバイダーを選択し、APIキーを入力して「保存」

### APIキーの取得

- **Gemini**: [Google AI Studio](https://aistudio.google.com/apikey) で取得
- **Claude**: [Anthropic Console](https://console.anthropic.com/) で取得
- **ChatGPT**: [OpenAI Platform](https://platform.openai.com/api-keys) で取得

## 使い方

1. [Marvel Unlimited](https://www.marvel.com/unlimited) でコミックを開く
2. リーダーが開くと、画面左上にDougのツールバーが表示される
3. 「翻訳」ボタンをクリックすると、現在ページの翻訳が実行される
4. 先読みが有効の場合、周辺ページがバックグラウンドで自動翻訳される
5. 翻訳済みのページに移動すると、キャッシュから即座にオーバーレイを表示可能

### ツールバー操作

| ボタン | 機能 |
|---|---|
| 翻訳 | 現在ページを翻訳してオーバーレイ表示 |
| 表示/非表示 | オーバーレイの表示切替 |
| クリア | オーバーレイを削除 |

ツールバーはドラッグで自由に移動できます。

## 構成ファイル

```
doug/
├── manifest.json        # 拡張機能の定義
├── background.js        # Service Worker（API・キャッシュ・先読み）
├── content.js           # コンテンツスクリプト（UI・オーバーレイ描画）
├── content.css          # オーバーレイのスタイル
├── popup.html/js/css    # 設定ポップアップ
├── offscreen.html/js    # Tesseract.js OCR（オフスクリーン）
├── lib/                 # Tesseract.js ライブラリ
├── lang/                # OCR言語データ
└── icons/               # 拡張機能アイコン（16/32/48/128px）
```

## 技術仕様

### レート制限対策

APIの429応答時は最大3回リトライ。`Retry-After` ヘッダーがあればその値を使用し、なければ10秒・20秒・30秒の段階的バックオフで再試行します。

### ページ検出

500ms間隔のポーリングでSVG `<image>` 要素の `href` 変化を監視し、ページ遷移を検知します。`MutationObserver` でリーダーダイアログの開閉も監視しています。

### オーバーレイ描画

- AIが返す正規化座標（0-1000）をパーセンテージに変換
- 吹き出しのbboxを上下10%拡張して表示
- 重なりがある場合は自動的に縮小調整
- フォントサイズは面積と文字数から推定し、収まらない場合は最小6pxまで縮小
